<?php

require_once 'login.php';
require_once 'common_functions.php';

$conn = new mysqli($hn, $un, $pw, $db);

if($conn->connect_error) die(mysql_fatal_error());
session_start();
if((isset($_SESSION['admin_username'])) && ($_SESSION['check'] == hash('ripemd128', $_SERVER['REMOTE_ADDR'] .$_SERVER['HTTP_USER_AGENT'])))
{
  if(!isset($_SESSION['initiated']))
  {
    session_regenerate_id();
    $_SESSION['initiated'] = 1;
  }
  echo "<!DOCTYPE html>\n<html><head><title>Malware Upload</title>";
  if(isset($_POST['admin_logout']))
  {
    echo "<h1>Logged out </h1><br>";
    echo "<a href='admin_login.php'>Click here</a> to login";
    destroy_session_and_data();
  }
  else
  {
    echo "<h1>Upload Malware</h1>";
    echo <<<_END
           <form method='post' action='malware_upload.php' enctype='multipart/form-data'>
                  Select File: <input type='file' name='filename' size='10'>
                  Name: <input type = "text" name = "name">
                  <input type='submit' value='Upload'>
           </form>
   _END;

   $nameUploaded = false;
   $fileUploaded = false;
   $name = null;
   if(isset($_POST['name']))
   {
     $name = mysql_entities_fix_string($conn, $_POST['name']);;
   }

   if($name == null)
   {
     echo "Name field is empty <br>";
   }

   else if(preg_match('/[^A-Za-z0-9]/', $name))
   {
     echo "Name can only contain letters and/or digits. No spaces. <br>";
   }

   else
   {
     $nameUploaded = true;
   }

   if($_FILES)
   {
     if($_FILES['filename']['name'] == null)
     {
       echo "No file has been uploaded <br>";
     }
     else
     {
       $fileUploaded = true;
       $filename = $_FILES['filename']['name'];
       $filename = preg_replace("/[^A-Za-z0-9.]/", "", $filename);
     }
   }
   else
   {
       echo "No file has been uploaded <br>";
   }

   if($nameUploaded && $fileUploaded)
   {
     $signature = "";
     if($_FILES['filename']['type'] === 'text/plain')
          $signature = get_file_signature($filename, true);
     else
          $signature = get_file_signature($filename, false);

     insert_malware_info($name, $signature, $conn);

     echo "Added file <br>";

   }

   echo "<br>";


    echo "<br>";
    echo <<<_END
        <form method='post' action='malware_upload.php' enctype='multipart/form-data'>
               <input type = 'hidden' name = 'admin_logout'>
               <input type='submit' value='Logout'>
        </form>
  _END;
  }
}
else
{
  echo "<!DOCTYPE html>\n<html><head><title>Not logged in</title>";
  echo "<h1>Not logged in </h1><br>";
  echo "Please <a href='admin_login.php'>click here</a> to login";
}

$conn->close();

function insert_malware_info($name, $signature, $conn)
{
  $stmt = $conn->prepare('INSERT INTO malware_info VALUES(?,?)');
  $stmt->bind_param('ss', $name, $signature);

  $name = $name;
  $signature = $signature;

  $stmt->execute();

  if($stmt->affected_rows == 0)
     mysql_fatal_error();

  $stmt->close();
}

function get_file_signature($filename, $isTextFile)
{
  $fh = fopen($filename, 'r') or die("Failed to open file");
  if(!$isTextFile)
    fgets($fh); //jump the header
  $signature = fread($fh, 20);
  fclose($fh);
  return $signature;
}

//destroy session
function destroy_session_and_data()
{
  $_SESSION = array();
  setcookie(session_name(), '', time() - 2592000, '/');
  session_destroy();
}

?>
